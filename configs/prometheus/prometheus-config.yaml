apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-server-conf
  namespace: monitoring
  labels:
    name: prometheus-server-conf
data:
  prometheus.rules: |-
    groups:
    # Node 레벨 알람 규칙
    - name: node.rules
      interval: 30s
      rules:
        - alert: NodeDown
          expr: up{job="node-exporter"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Node {{ $labels.instance }} is down"
            description: "Node {{ $labels.instance }} has been down for more than 5 minutes."

        - alert: HighCPUUsage
          expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.instance }}"
            description: "CPU usage is above 80% on node {{ $labels.instance }} for more than 5 minutes."

        - alert: HighMemoryUsage
          expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on {{ $labels.instance }}"
            description: "Memory usage is above 80% on node {{ $labels.instance }} for more than 5 minutes."

        - alert: DiskSpaceLow
          expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Low disk space on {{ $labels.instance }}"
            description: "Disk space is below 20% on node {{ $labels.instance }}."

    # Pod 레벨 알람 규칙
    - name: pod.rules
      interval: 30s
      rules:
        - alert: PodCrashLooping
          expr: kube_pod_container_status_restarts_total > 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} in {{ $labels.namespace }} is crash looping"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in the last 5 minutes."

        - alert: PodNotReady
          expr: kube_pod_status_phase{phase!="Running",phase!="Succeeded"} == 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} in {{ $labels.namespace }} is not ready"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been in {{ $labels.phase }} state for more than 10 minutes."

        - alert: PodHighCPUUsage
          expr: sum(rate(container_cpu_usage_seconds_total{pod!="",container!="POD",container!=""}[5m])) by (pod, namespace) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on pod {{ $labels.pod }} in {{ $labels.namespace }}"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using {{ $value | humanize }} CPU cores (above 80%)."

        - alert: PodHighMemoryUsage
          expr: sum(container_memory_working_set_bytes{pod!="",container!="POD",container!=""}) by (pod, namespace) / sum(container_spec_memory_limit_bytes{pod!="",container!="POD",container!=""}) by (pod, namespace) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on pod {{ $labels.pod }} in {{ $labels.namespace }}"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using more than 80% of its memory limit."

        - alert: PodRestarting
          expr: increase(kube_pod_container_status_restarts_total[15m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} in {{ $labels.namespace }} is restarting"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in the last 15 minutes."

    # 기존 Container 레벨 알람 규칙 (유지)
    - name: container memory alert
      rules:
      - alert: container memory usage rate is very high( > 55%)
        expr: sum(container_memory_working_set_bytes{pod!=""}) / sum(kube_node_status_allocatable_memory_bytes) * 100 > 55
        for: 1m
        labels:
          severity: fatal
        annotations:
          summary: High Memory Usage on {{ $labels.instance }}
          description: "{{ $labels.job }} Memory Usage: {{ $value }}"

    - name: container CPU alert
      rules:
      - alert: container CPU usage rate is very high( > 10%)
        expr: sum(rate(container_cpu_usage_seconds_total{pod!=""}[1m])) / sum(machine_cpu_cores) * 100 > 10
        for: 1m
        labels:
          severity: fatal
        annotations:
          summary: High CPU Usage
          description: "{{ $labels.job }} CPU Usage: {{ $value }}"

  prometheus.yml: |-
    global:
      scrape_interval: 5s
      evaluation_interval: 5s

    rule_files:
      - /etc/prometheus/prometheus.rules

    alerting:
      alertmanagers:
      - scheme: http
        static_configs:
        - targets:
          - "alertmanager.monitoring.svc:9093"

    scrape_configs:
      # 1. Kubernetes API Server (오직 default/kubernetes만 타겟)
      - job_name: 'kubernetes-apiservers'
        scheme: https
        kubernetes_sd_configs:
        - role: endpoints
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - action: keep
          source_labels:
            - __meta_kubernetes_namespace
            - __meta_kubernetes_service_name
          regex: default;kubernetes

      # 2. Node Exporter (각 노드의 pod별 메트릭 수집 - DaemonSet 자동 발견)
      - job_name: 'node-exporter'
        scheme: http
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        # monitoring 네임스페이스의 node-exporter Pod만 선택 (k8s-app label 사용)
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_label_k8s_app]
          action: keep
          regex: monitoring;node-exporter
        # metrics 포트만 선택 (containerPort 이름)
        - source_labels: [__meta_kubernetes_pod_container_port_name]
          action: keep
          regex: metrics
        # Pod IP와 포트를 주소로 설정
        - source_labels: [__meta_kubernetes_pod_ip]
          action: replace
          target_label: __address__
          replacement: $1:9100
        # Pod별로 고유한 instance 라벨 생성 (Pod 이름 기반)
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: instance
          replacement: $1:9100
        # 라벨 추가
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        # Pod 정보 라벨 추가
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name
        - source_labels: [__meta_kubernetes_pod_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_pod_uid]
          action: replace
          target_label: kubernetes_pod_uid
        # 노드 정보는 라벨로만 유지 (단일 노드 정보)
        - source_labels: [__meta_kubernetes_node_name]
          action: replace
          target_label: kubernetes_node_name

      # 3. kube-state-metrics (Kubernetes 리소스 메트릭)
      - job_name: 'kube-state-metrics'
        static_configs:
        - targets:
          - 'kube-state-metrics.kube-system.svc.cluster.local:8080'

      # 4. Kubernetes Nodes (노드 레벨 메트릭)
      - job_name: 'kubernetes-nodes'
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics

      # 5. Kubernetes Pods (모든 실행 중인 Pod 자동 추적)
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        # 실행 중인 Pod만 선택 (Completed, Error, Pending 제외)
        - source_labels: [__meta_kubernetes_pod_phase]
          action: keep
          regex: Running
        # 모든 실행 중인 Pod 추적 (어노테이션 필터 제거)
        # 메트릭 경로 설정 (어노테이션이 있으면 사용, 없으면 기본값 /metrics)
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
          replacement: ${1}
        # 포트 설정 (어노테이션이 있으면 사용, 없으면 Pod IP의 기본 포트 사용)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
        # 라벨 추가
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name
        - source_labels: [__meta_kubernetes_pod_node_name]
          action: replace
          target_label: kubernetes_node_name
        - source_labels: [__meta_kubernetes_pod_controller_kind]
          action: replace
          target_label: kubernetes_pod_controller_kind
        - source_labels: [__meta_kubernetes_pod_controller_name]
          action: replace
          target_label: kubernetes_pod_controller_name

      # 6. Cadvisor (컨테이너 메트릭 - 각 노드의 cAdvisor)
      - job_name: 'kubernetes-cadvisor'
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
